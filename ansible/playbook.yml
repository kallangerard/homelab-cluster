---
# ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i inventory.yml playbook.yml

- name: Initialise common roles
  hosts: '{{ lookup("env", "STAGE") | lower | default("development", true) }}'
  roles:
    - ssh
    - homelab-cluster
    - docker
    - kubernetes-common

- name: Initialise master nodes
  hosts: '{{ lookup("env", "STAGE") | lower | default("development", true) }}_masters'
  roles:
    - kubernetes-master

- name: Initialise worker nodes
  hosts: '{{ lookup("env", "STAGE") | lower | default("development", true) }}_workers'
  roles:
    - kubernetes-worker

- name: Install Ingress Controller
  hosts: '{{ lookup("env", "STAGE") | lower | default("development", true) }}_masters'
  roles:
    - kubernetes-services
# TODO Kubernetes
#master
# ---

# kubeadm init --pod-network-cidr {{ cluster_cidr }} #"10.200.0.0/16"

# template from /templates/calico/v{{ calico_version }}/manifests/calico.yml
# to {{ temp }}/calico.yml

# command: {{ temp }}/calico.yaml

# kubectl taint nodes --all node-role.kubernetes.io/master-

# workers
# ---

# kubeadm token create
# ^ register token ^

# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
#    openssl dgst -sha256 -hex | sed 's/^.* //'
# ^ register ca-cert-hash ^

# kubeadm join --token <token> <control-plane-host>:<control-plane-port> --discovery-token-ca-cert-hash sha256:<hash>
